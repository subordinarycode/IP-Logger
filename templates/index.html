<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Information</title>
    <script>
        // Pass the Flask variable to JavaScript
        const attemptGeolocation = {{ attempt_geolocation | tojson }};
    </script>
</head>
<body>
<script>
function getGeolocation(callback) {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                callback({ latitude, longitude });
            },
            (error) => {
                let errorMessage = "";
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "User denied the request for Geolocation.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = "Location information is unavailable.";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "The request to get user location timed out.";
                        break;
                    case error.UNKNOWN_ERROR:
                        errorMessage = "An unknown error occurred.";
                        break;
                }
                callback(null, errorMessage);
            }
        );
    } else {
        callback(null, "Geolocation is not supported by this browser.");
    }
}

function fetchIPAddress() {
    return fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => data.ip)
        .catch(error => {
            console.error('Error fetching IP address:', error);
            return "Unknown";
        });
}

function fetchISP(ip) {
    return fetch(`http://ip-api.com/json/${ip}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => data.org || "ISP information not available")
        .catch(error => {
            console.error('Error fetching ISP information:', error);
            return "Unknown";
        });
}

function fetchUserInformation(attemptGeolocation = false) {
    let latitude = 0.0,
        longitude = 0.0,
        publicIP = null,
        isp = null;

    // Only attempt to get geolocation if the parameter is true
    if (attemptGeolocation) {
        getGeolocation((location, errorMessage) => {
            if (location) {
                latitude = location.latitude;
                longitude = location.longitude;
            } else {
                console.error('Error getting location:', errorMessage);
            }

            // Proceed to fetch the IP address and ISP information
            fetchUserData();
        });
    } else {
        // If no geolocation is needed, proceed directly to fetching user data
        fetchUserData();
    }

    function fetchUserData() {
        fetchIPAddress()
            .then(ip => {
                publicIP = ip;

                if (publicIP) {
                    return fetchISP(publicIP);
                }
                return "127.0.0.1"; // Return localhost if public IP isn't available
            })
            .then(ispInfo => {
                isp = ispInfo;

                const userInfo = {
                    latitude,
                    longitude,
                    publicIP,
                    isp,
                    userAgent: navigator.userAgent,
                    platform: detectPlatform(),
                    screenWidth: screen.width,
                    screenHeight: screen.height,
                    colorDepth: screen.colorDepth,
                    viewportWidth: window.innerWidth,
                    viewportHeight: window.innerHeight,
                    isOnline: navigator.onLine ? "Online" : "Offline",
                    language: navigator.language || navigator.userLanguage,
                    languagePreferences: navigator.languages.join(', '),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    cookiesEnabled: navigator.cookieEnabled ? "Yes" : "No",
                    doNotTrack: navigator.doNotTrack === "1" ? "Yes" : "No",
                    connectionType: navigator.connection?.effectiveType || "N/A",
                };

                // Send User Information to the Flask Server
                return fetch('/user_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userInfo)
                });
            })
            .then(response => response.json())
            .then(data => {
                // Redirect to the specified URL after processing
                window.location.href = data.redirect;
            })
            .catch(error => console.error('Error sending data to server:', error));
    }
}


function detectPlatform() {
    const userAgent = navigator.userAgent;
    if (/android/i.test(userAgent)) return "Android";
    if (/iPhone/i.test(userAgent)) return "iPhone";
    if (/iPad/i.test(userAgent)) return "iPad";
    if (/Macintosh/i.test(userAgent)) return "Mac OS";
    if (/Windows/i.test(userAgent)) return "Windows";
    if (/Linux/i.test(userAgent)) return "Linux";
    return "Unknown Platform";
}

// Call fetchUserInformation with the desired geolocation flag when the page loads
window.onload = function() {
    fetchUserInformation(attemptGeolocation);
};
    </script>
</body>
</html>
